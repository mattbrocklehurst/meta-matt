From 3bff47fb2f995c1a93173a63829681d31bf8e026 Mon Sep 17 00:00:00 2001
From: Matt Brocklehurst <matt@mattbrocklehurst.co.uk>
Date: Sun, 11 Jan 2026 19:19:43 +0000
Subject: [PATCH] Fix GCC 14 compatibility regressions

---
 jdk/src/share/bin/splashscreen_stubs.c             |  6 +++---
 jdk/src/share/instrument/JarFacade.c               |  7 -------
 .../share/native/sun/awt/image/jpeg/imageioJPEG.c  | 14 +++++++-------
 jdk/src/share/native/sun/misc/URLClassPath.c       |  5 ++++-
 .../native/sun/nio/fs/LinuxNativeDispatcher.c      |  1 +
 .../native/sun/security/pkcs11/j2secmod_md.c       | 10 ++++++++++
 6 files changed, 25 insertions(+), 18 deletions(-)

diff --git openjdk/jdk/src/share/bin/splashscreen_stubs.c openjdk/jdk/src/share/bin/splashscreen_stubs.c
index 9c1f5148..32e32b0b 100644
--- openjdk/jdk/src/share/bin/splashscreen_stubs.c
+++ openjdk/jdk/src/share/bin/splashscreen_stubs.c
@@ -61,11 +61,11 @@ typedef char* (*SplashGetScaledImageName_t)(const char* fileName,
 #define INVOKEV(name) _INVOKE(name, ,;)
 
 int     DoSplashLoadMemory(void* pdata, int size) {
-    INVOKE(SplashLoadMemory, NULL)(pdata, size);
+    INVOKE(SplashLoadMemory, 0)(pdata, size);
 }
 
 int     DoSplashLoadFile(const char* filename) {
-    INVOKE(SplashLoadFile, NULL)(filename);
+    INVOKE(SplashLoadFile, 0)(filename);
 }
 
 void    DoSplashInit(void) {
@@ -87,4 +87,4 @@ void    DoSplashSetScaleFactor(float scaleFactor) {
 char*    DoSplashGetScaledImageName(const char* fileName, const char* jarName,
                                     float* scaleFactor) {
     INVOKE(SplashGetScaledImageName, NULL)(fileName, jarName, scaleFactor);
-}
\ No newline at end of file
+}
diff --git openjdk/jdk/src/share/instrument/JarFacade.c openjdk/jdk/src/share/instrument/JarFacade.c
index 07ae23c2..3b1c6e40 100644
--- openjdk/jdk/src/share/instrument/JarFacade.c
+++ openjdk/jdk/src/share/instrument/JarFacade.c
@@ -23,14 +23,7 @@
  * questions.
  */
 
-#ifdef _WIN32
-/*
- * Win* needs this include. However, Linux and Solaris do not.
- * Having this include on Solaris SPARC breaks having non US-ASCII
- * characters in the value of the Premain-Class attribute.
- */
 #include <ctype.h>
-#endif /* _WIN32 */
 #include <string.h>
 #include <stdlib.h>
 
diff --git openjdk/jdk/src/share/native/sun/awt/image/jpeg/imageioJPEG.c openjdk/jdk/src/share/native/sun/awt/image/jpeg/imageioJPEG.c
index 8cac61da..40fc4926 100644
--- openjdk/jdk/src/share/native/sun/awt/image/jpeg/imageioJPEG.c
+++ openjdk/jdk/src/share/native/sun/awt/image/jpeg/imageioJPEG.c
@@ -2850,14 +2850,14 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
     pb = &data->pixelBuf;
 
     if (setPixelBuffer(env, pb, buffer) == NOT_OK) {
-        freeArray(scale, numBands);
+        freeArray((void **) scale, numBands);
         return data->abortFlag;  // We already threw an out of memory exception
     }
 
     // Allocate a 1-scanline buffer
     scanLinePtr = (JSAMPROW)malloc(scanLineSize);
     if (scanLinePtr == NULL) {
-        freeArray(scale, numBands);
+        freeArray((void **) scale, numBands);
         JNU_ThrowByName( env,
                          "java/lang/OutOfMemoryError",
                          "Writing JPEG Stream");
@@ -2879,7 +2879,7 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
             JNU_ThrowByName(env, "javax/imageio/IIOException", buffer);
         }
 
-        freeArray(scale, numBands);
+        freeArray((void **) scale, numBands);
         free(scanLinePtr);
         return data->abortFlag;
     }
@@ -2928,7 +2928,7 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
         (*env)->ReleaseIntArrayElements(env, QtableSelectors, qsels, JNI_ABORT);
     }
     if (!success) {
-        freeArray(scale, numBands);
+        freeArray((void **) scale, numBands);
         free(scanLinePtr);
         return data->abortFlag;
     }
@@ -2949,7 +2949,7 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
     if (GET_ARRAYS(env, data,
                    (const JOCTET **)(&dest->next_output_byte)) == NOT_OK) {
         (*env)->ExceptionClear(env);
-        freeArray(scale, numBands);
+        freeArray((void **) scale, numBands);
         free(scanLinePtr);
         JNU_ThrowByName(env,
                         "javax/imageio/IIOException",
@@ -2987,7 +2987,7 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
             scanData = (*env)->GetIntArrayElements(env, scanInfo, NULL);
             if (scanData == NULL) {
                 RELEASE_ARRAYS(env, data, (const JOCTET *)(dest->next_output_byte));
-                freeArray(scale, numBands);
+                freeArray((void **) scale, numBands);
                 free(scanLinePtr);
                 return data->abortFlag;
             }
@@ -3086,7 +3086,7 @@ Java_com_sun_imageio_plugins_jpeg_JPEGImageWriter_writeImage
         jpeg_abort((j_common_ptr)cinfo);
     }
 
-    freeArray(scale, numBands);
+    freeArray((void **) scale, numBands);
     free(scanLinePtr);
     RELEASE_ARRAYS(env, data, NULL);
     return data->abortFlag;
diff --git openjdk/jdk/src/share/native/sun/misc/URLClassPath.c openjdk/jdk/src/share/native/sun/misc/URLClassPath.c
index e0ad4f81..20a813d0 100644
--- openjdk/jdk/src/share/native/sun/misc/URLClassPath.c
+++ openjdk/jdk/src/share/native/sun/misc/URLClassPath.c
@@ -24,7 +24,7 @@
  */
 
 #include <string.h>
-
+#include <stdlib.h>
 #include "jni.h"
 #include "jni_util.h"
 #include "jlong.h"
@@ -36,6 +36,9 @@
 extern char*
 getUTF(JNIEnv *env, jstring str, char* localBuf, int bufSize);
 
+extern void VerifyFixClassname(char *name);
+extern jboolean VerifyClassname(char *name, jboolean allowArray);
+
 
 JNIEXPORT jboolean JNICALL
 Java_sun_misc_URLClassPath_knownToNotExist0(JNIEnv *env, jclass cls, jobject loader,
diff --git openjdk/jdk/src/solaris/native/sun/nio/fs/LinuxNativeDispatcher.c openjdk/jdk/src/solaris/native/sun/nio/fs/LinuxNativeDispatcher.c
index bd836bfc..418f94bf 100644
--- openjdk/jdk/src/solaris/native/sun/nio/fs/LinuxNativeDispatcher.c
+++ openjdk/jdk/src/solaris/native/sun/nio/fs/LinuxNativeDispatcher.c
@@ -30,6 +30,7 @@
 
 #include <stdio.h>
 #include <string.h>
+#include <stdlib.h>
 #include <dlfcn.h>
 #include <errno.h>
 #include <mntent.h>
diff --git openjdk/jdk/src/solaris/native/sun/security/pkcs11/j2secmod_md.c openjdk/jdk/src/solaris/native/sun/security/pkcs11/j2secmod_md.c
index 0b89f11c..c9bf2de3 100644
--- openjdk/jdk/src/solaris/native/sun/security/pkcs11/j2secmod_md.c
+++ openjdk/jdk/src/solaris/native/sun/security/pkcs11/j2secmod_md.c
@@ -33,6 +33,16 @@
 
 #include "j2secmod.h"
 
+static void throwNullPointerException(JNIEnv *env, const char *msg) {
+    jclass cls = (*env)->FindClass(env, "java/lang/NullPointerException");
+    if (cls != NULL) (*env)->ThrowNew(env, cls, msg);
+}
+
+static void throwIOException(JNIEnv *env, const char *msg) {
+    jclass cls = (*env)->FindClass(env, "java/io/IOException");
+    if (cls != NULL) (*env)->ThrowNew(env, cls, msg);
+}
+
 void *findFunction(JNIEnv *env, jlong jHandle, const char *functionName) {
     void *hModule = (void*)jlong_to_ptr(jHandle);
     void *fAddress = dlsym(hModule, functionName);
-- 
2.52.0

